<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate - Yield For Good</title>
    <!-- Remove the old ethers script and add these two scripts -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script>
        // Ensure ethers is available globally
        if (typeof ethers === 'undefined') {
            window.ethers = ethers;
        }
    </script>
    <!-- Rest of the head content remains the same -->
    <style>
        /* ... (keep all your existing styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing body content) ... -->
    
    <script>
        // Wait for ethers to be fully loaded
        window.addEventListener('load', () => {
            if (typeof window.ethers === 'undefined') {
                console.error('Ethers library not loaded properly');
                return;
            }

            let contract;
            let signer;

            const contractABI = [
                "function deposit(uint256 lockTime) payable external nonReentrant",
                "function withdraw() external nonReentrant"
            ];
            const contractAddress = "0xd9582a10448fA9eC8f816782664e97051B0Fd931";

            async function connectWallet() {
                try {
                    if (typeof window.ethereum === 'undefined') {
                        throw new Error('Please install MetaMask to use this feature');
                    }

                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    
                    return true;
                } catch (error) {
                    showStatus(error.message, true);
                    return false;
                }
            }

            // Make functions globally accessible
            window.connectWallet = connectWallet;
            window.withdrawFunds = async function() {
                try {
                    if (!await connectWallet()) return;

                    const tx = await contract.withdraw();
                    showStatus('Processing withdrawal...');
                    
                    await tx.wait();
                    showStatus('Withdrawal successful!');
                } catch (error) {
                    showStatus(error.message, true);
                }
            };

            window.openModal = function(charityName) {
                const modal = document.getElementById('donationModal');
                const modalTitle = document.getElementById('modalTitle');
                modalTitle.textContent = `Donate to ${charityName}`;
                modal.classList.add('active');
            };

            window.closeModal = function() {
                const modal = document.getElementById('donationModal');
                modal.classList.remove('active');
                document.getElementById('status-message').style.display = 'none';
            };

            window.showStatus = function(message, isError = false) {
                const statusElement = document.getElementById('status-message');
                statusElement.textContent = message;
                statusElement.className = isError ? 'error' : 'success';
                statusElement.style.display = 'block';
            };

            document.getElementById('donationModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    window.closeModal();
                }
            });

            document.getElementById('donationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!await connectWallet()) return;

                const ethAmount = document.getElementById('eth-amount').value;
                const lockPeriod = document.getElementById('lock-period').value;

                try {
                    const weiAmount = ethers.utils.parseEther(ethAmount.toString());
                    
                    const tx = await contract.deposit(lockPeriod, {
                        value: weiAmount
                    });

                    showStatus('Processing transaction...');
                    
                    await tx.wait();
                    
                    showStatus('Donation successful!');
                    
                    setTimeout(window.closeModal, 2000);
                } catch (error) {
                    showStatus(error.message, true);
                }
            });
        });
    </script>
</body>
</html>
