<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate - Yield For Good</title>
    <!-- Replace the old ethers.js CDN with this one -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <!-- Keep all the same CSS -->
    <style>
        /* Keep all the existing CSS */
    </style>
</head>
<body>
    <!-- Keep all the existing HTML -->
    
    <script>
        // Add a check to ensure ethers is loaded
        if (typeof ethers === 'undefined') {
            console.error('Ethers.js failed to load');
        } else {
            console.log('Ethers.js loaded successfully');
        }

        const contractABI = [
            "function deposit(uint256 lockTime) payable external nonReentrant",
            "function withdraw() external nonReetrant"
        ];

        const contractAddress = "0xd9582a10448fA9eC8f816782664e97051B0Fd931";

        let selectedCharity = '';
        let contract;
        let signer;

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('Please install MetaMask to use this feature');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                return true;
            } catch (error) {
                showStatus(error.message, true);
                return false;
            }
        }

        async function withdrawFunds() {
            try {
                if (!await connectWallet()) {
                    return;
                }

                const tx = await contract.withdraw();
                showStatus('Processing withdrawal...');
                
                await tx.wait();
                showStatus('Withdrawal successful!');
            } catch (error) {
                showStatus(error.message, true);
            }
        }

        function openModal(charityName) {
            selectedCharity = charityName;
            const modal = document.getElementById('donationModal');
            const modalTitle = document.getElementById('modalTitle');
            modalTitle.textContent = `Donate to ${charityName}`;
            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('donationModal');
            modal.classList.remove('active');
            document.getElementById('status-message').style.display = 'none';
        }

        function showStatus(message, isError = false) {
            const statusElement = document.getElementById('status-message');
            statusElement.textContent = message;
            statusElement.className = isError ? 'error' : 'success';
            statusElement.style.display = 'block';
        }

        document.getElementById('donationModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('donationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!await connectWallet()) {
                return;
            }

            const ethAmount = document.getElementById('eth-amount').value;
            const lockPeriod = document.getElementById('lock-period').value;

            try {
                const weiAmount = ethers.utils.parseEther(ethAmount.toString());
                
                const tx = await contract.deposit(lockPeriod, {
                    value: weiAmount
                });

                showStatus('Processing transaction...');
                
                await tx.wait();
                
                showStatus('Donation successful!');
                
                setTimeout(closeModal, 2000);
            } catch (error) {
                showStatus(error.message, true);
            }
        });
    </script>
</body>
</html>
